<script>
    let qrInstance = null;

    function generateQRCode() {
        const url = document.getElementById("url").value.trim();
        const qrCodeDiv = document.getElementById("qrcode");
        qrCodeDiv.innerHTML = "";
        document.getElementById("downloadBtn").style.display = "none";

        if (!url) {
            alert("Please enter a valid URL");
            return;
        }

        qrInstance = new QRCode(qrCodeDiv, {
            text: url,
            width: 180,
            height: 180,
            colorDark: "#000000",
            colorLight: "#ffffff",   // Forces white background
            correctLevel: QRCode.CorrectLevel.H
        });

        // Wait for QR to render, then normalize canvas
        setTimeout(makeWhiteBackground, 300);
    }

    function makeWhiteBackground() {
        const qrCanvas = document.querySelector("#qrcode canvas");
        if (!qrCanvas) return;

        const ctx = qrCanvas.getContext("2d");
        const imgData = ctx.getImageData(0, 0, qrCanvas.width, qrCanvas.height);

        // Force transparent pixels â†’ white
        for (let i = 0; i < imgData.data.length; i += 4) {
            if (imgData.data[i + 3] === 0) {
                imgData.data[i] = 255;
                imgData.data[i + 1] = 255;
                imgData.data[i + 2] = 255;
                imgData.data[i + 3] = 255;
            }
        }

        ctx.putImageData(imgData, 0, 0);
        document.getElementById("downloadBtn").style.display = "block";
    }

    function downloadQRCode() {
        const qrCanvas = document.querySelector("#qrcode canvas");
        if (!qrCanvas) return;

        const link = document.createElement("a");
        link.href = qrCanvas.toDataURL("image/png"); // lossless, keeps edges sharp
        link.download = "qrcode.png";
        link.click();
    }
</script>
